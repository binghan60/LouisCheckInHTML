<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>月度加班費計算器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }
        .month-selector {
            display: flex;
            align-items: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .time-input {
            width: 80px;
            padding: 5px;
        }
        .save-btn {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ef;
            border-radius: 4px;
        }
        .weekend {
            background-color: #ffebee;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>月度加班費計算器</h1>
        
        <div class="controls">
            <div class="month-selector">
                <label for="year">年份:</label>
                <select id="year" onchange="loadMonthData()">
                    <!-- 年份選項會動態生成 -->
                </select>
                
                <label for="month" style="margin-left: 20px;">月份:</label>
                <select id="month" onchange="loadMonthData()">
                    <!-- 月份選項會動態生成 -->
                </select>
            </div>
        </div>
        
        <table id="overtime-table">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>星期</th>
                    <th>上班時間</th>
                    <th>下班時間</th>
                    <th>正常工時</th>
                    <th>加班時數</th>
                    <th>加班費</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- 表格內容會動態生成 -->
            </tbody>
        </table>
        
        <div style="text-align: right; margin-top: 15px;">
            <button class="save-btn" onclick="saveData()">保存數據</button>
        </div>
        
        <div class="summary">
            <h3>本月加班統計</h3>
            <p>總加班時數: <span id="total-hours">0</span> 小時</p>
            <p>總加班費: <span id="total-pay">0</span> 元</p>
        </div>
    </div>

    <script>
        // 全局變量
        let monthData = [];
        const hourlyRate = 200; // 假設每小時加班費為200元
        const normalHours = 8; // 正常工作時數
        const weekdayNames = ['日', '一', '二', '三', '四', '五', '六'];
        
        // 頁面加載時初始化
        window.onload = function() {
            populateYearOptions();
            populateMonthOptions();
            loadMonthData();
        };
        
        // 填充年份選項
        function populateYearOptions() {
            const yearSelect = document.getElementById('year');
            const currentYear = new Date().getFullYear();
            
            for (let i = currentYear - 2; i <= currentYear + 2; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + '年';
                if (i === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }
        
        // 填充月份選項
        function populateMonthOptions() {
            const monthSelect = document.getElementById('month');
            
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + '月';
                if (i === new Date().getMonth() + 1) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            }
        }
        
        // 獲取某月的天數
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }
        
        // 加載選定月份的數據
        function loadMonthData() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            
            // 先從後端獲取數據
            fetch(`/api/overtime?year=${year}&month=${month}`)
                .then(response => response.json())
                .then(data => {
                    // 將數據轉換為以日期為鍵的對象，方便後續處理
                    const dataMap = {};
                    data.forEach(item => {
                        dataMap[item.date] = item;
                    });
                    
                    // 創建整月的數據
                    const daysInMonth = getDaysInMonth(year, month);
                    monthData = [];
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayDate = new Date(year, month - 1, day);
                        const weekday = dayDate.getDay(); // 0 是星期日，1-6 是星期一到星期六
                        
                        // 如果有現有數據，使用它，否則創建新項目
                        if (dataMap[date]) {
                            monthData.push({
                                ...dataMap[date],
                                weekday: weekdayNames[weekday]
                            });
                        } else {
                            monthData.push({
                                date: date,
                                weekday: weekdayNames[weekday],
                                startTime: '',
                                endTime: '',
                                overtimeHours: 0,
                                overtimePay: 0
                            });
                        }
                    }
                    
                    renderTable();
                    updateSummary();
                })
                .catch(error => {
                    console.error('加載數據失敗:', error);
                    
                    // 如果加載失敗，使用空數據創建整月表格
                    const year = parseInt(document.getElementById('year').value);
                    const month = parseInt(document.getElementById('month').value);
                    const daysInMonth = getDaysInMonth(year, month);
                    monthData = [];
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayDate = new Date(year, month - 1, day);
                        const weekday = dayDate.getDay();
                        
                        monthData.push({
                            date: date,
                            weekday: weekdayNames[weekday],
                            startTime: '',
                            endTime: '',
                            overtimeHours: 0,
                            overtimePay: 0
                        });
                    }
                    
                    renderTable();
                    updateSummary();
                });
        }
        
        // 渲染表格
        function renderTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            monthData.forEach((entry, index) => {
                const row = document.createElement('tr');
                
                // 判斷是否為週末
                const isWeekend = entry.weekday === '六' || entry.weekday === '日';
                if (isWeekend) {
                    row.classList.add('weekend');
                }
                
                // 日期
                const dateCell = document.createElement('td');
                dateCell.textContent = entry.date;
                row.appendChild(dateCell);
                
                // 星期
                const weekdayCell = document.createElement('td');
                weekdayCell.textContent = entry.weekday;
                row.appendChild(weekdayCell);
                
                // 上班時間
                const startTimeCell = document.createElement('td');
                const startTimeInput = document.createElement('input');
                startTimeInput.type = 'time';
                startTimeInput.className = 'time-input';
                startTimeInput.value = entry.startTime || '';
                startTimeInput.onchange = () => updateTimeAndCalculate(index, 'startTime', startTimeInput.value);
                startTimeCell.appendChild(startTimeInput);
                row.appendChild(startTimeCell);
                
                // 下班時間
                const endTimeCell = document.createElement('td');
                const endTimeInput = document.createElement('input');
                endTimeInput.type = 'time';
                endTimeInput.className = 'time-input';
                endTimeInput.value = entry.endTime || '';
                endTimeInput.onchange = () => updateTimeAndCalculate(index, 'endTime', endTimeInput.value);
                endTimeCell.appendChild(endTimeInput);
                row.appendChild(endTimeCell);
                
                // 正常工時
                const normalHoursCell = document.createElement('td');
                normalHoursCell.textContent = normalHours;
                row.appendChild(normalHoursCell);
                
                // 加班時數
                const overtimeHoursCell = document.createElement('td');
                overtimeHoursCell.textContent = entry.overtimeHours ? entry.overtimeHours.toFixed(2) : '0.00';
                row.appendChild(overtimeHoursCell);
                
                // 加班費
                const overtimePayCell = document.createElement('td');
                overtimePayCell.textContent = entry.overtimePay ? entry.overtimePay.toFixed(2) : '0.00';
                row.appendChild(overtimePayCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // 更新時間並計算加班費
        function updateTimeAndCalculate(index, field, value) {
            monthData[index][field] = value;
            
            // 計算加班時數和加班費
            if (monthData[index].startTime && monthData[index].endTime) {
                const startTime = new Date(`2000-01-01T${monthData[index].startTime}`);
                const endTime = new Date(`2000-01-01T${monthData[index].endTime}`);
                
                // 如果結束時間早於開始時間，假設是跨日
                if (endTime < startTime) {
                    endTime.setDate(endTime.getDate() + 1);
                }
                
                // 計算工作總時間（小時）
                const totalHours = (endTime - startTime) / (1000 * 60 * 60);
                
                // 計算加班時數（大於正常工時的部分）
                const overtimeHours = Math.max(0, totalHours - normalHours);
                monthData[index].overtimeHours = overtimeHours;
                
                // 計算加班費
                monthData[index].overtimePay = overtimeHours * hourlyRate;
                
                // 更新表格並重新計算摘要
                renderTable();
                updateSummary();
            }
        }
        
        // 更新摘要
        function updateSummary() {
            let totalHours = 0;
            let totalPay = 0;
            
            monthData.forEach(entry => {
                totalHours += entry.overtimeHours || 0;
                totalPay += entry.overtimePay || 0;
            });
            
            document.getElementById('total-hours').textContent = totalHours.toFixed(2);
            document.getElementById('total-pay').textContent = totalPay.toFixed(2);
        }
        
        // 保存數據到後端
        function saveData() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            
            // 僅保存有輸入的數據
            const dataToSave = monthData.filter(entry => entry.startTime || entry.endTime);
            
            fetch('/api/overtime', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    year: year,
                    month: month,
                    data: dataToSave
                })
            })
            .then(response => response.json())
            .then(result => {
                alert('數據保存成功！');
            })
            .catch(error => {
                console.error('保存數據失敗:', error);
                alert('保存失敗，請重試！');
            });
        }
    </script>
</body>
</html>