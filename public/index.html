<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>冠宇加班費計算器</title>
        <!-- Add SheetJS Library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
            /* --- 基本樣式 --- */
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f5f5f5;
                line-height: 1.6;
            }

            .container {
                max-width: 1000px;
                margin: 20px auto;
                background-color: white;
                padding: 25px;
                border-radius: 8px;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            }

            h1 {
                text-align: center;
                color: #333;
                margin-top: 0;
                margin-bottom: 25px;
                font-size: 2em;
            }

            .controls {
                margin-bottom: 25px;
                text-align: center;
            }

            .month-selector {
                display: flex;
                align-items: center;
                gap: 10px;
                background-color: #f8f9fa;
                padding: 10px 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                flex-wrap: wrap;
                justify-content: center;
            }

            .month-selector label {
                font-weight: 500;
                color: #495057;
                white-space: nowrap;
            }

            .month-selector select {
                padding: 8px 12px;
                border: 1px solid #ced4da;
                border-radius: 5px;
                background-color: #ffffff;
                color: #495057;
                font-size: 1rem;
                cursor: pointer;
                transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
                background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236c757d%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
                background-repeat: no-repeat;
                background-position: right 10px center;
                background-size: 10px 10px;
                padding-right: 30px;
                flex-grow: 1;
                min-width: 80px;
            }

            .month-selector select::-ms-expand {
                display: none;
            }
            .month-selector select:hover {
                border-color: #adb5bd;
            }
            .month-selector select:focus {
                outline: none;
                border-color: #86b7fe;
                box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            }

            .month-nav-btn {
                padding: 7px 12px;
                font-size: 0.95rem;
                font-weight: 500;
                line-height: 1.5;
                color: #007bff;
                background-color: #ffffff;
                border: 1px solid #ced4da;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
                white-space: nowrap;
            }

            .month-nav-btn:hover {
                background-color: #e9ecef;
                border-color: #adb5bd;
                color: #0056b3;
            }
            .month-nav-btn:active {
                background-color: #ced4da;
            }
            .month-nav-btn:focus {
                outline: none;
                box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            }

            /* --- RWD Table Container --- */
            .table-container {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-top: 20px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                min-width: 750px;
            }

            th,
            td {
                border: 1px solid #ddd;
                padding: 10px 12px;
                text-align: center;
                white-space: nowrap;
                vertical-align: middle;
            }

            th {
                background-color: #f2f2f2;
                font-weight: 600;
                position: sticky;
                top: 0;
                z-index: 1;
            }

            tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            tr:hover {
                background-color: #f1f1f1;
            }

            .time-input {
                width: 140px;
                padding: 6px 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 0.95rem;
                box-sizing: border-box;
            }

            /* --- Action Buttons Container --- */
            .action-buttons {
                margin-top: 25px; /* Or your preferred margin */
                display: flex; /* Enable Flexbox */
                justify-content: space-between; /* Push left group and save button apart */
                align-items: flex-start; /* Align tops of items */
                flex-wrap: wrap; /* Allow wrapping on smaller screens */
                gap: 20px; /* Add gap between items when they wrap */
            }

            /* --- Left Button Group (Import, Template, Status) --- */
            .button-group-left {
                display: flex; /* Use flexbox for the inner group too */
                flex-wrap: wrap; /* Allow buttons inside to wrap if needed */
                align-items: center; /* Vertically center buttons in this group */
                gap: 15px; /* Space between Import and Template buttons */
            }

            /* --- General Action Button Styling --- */
            .action-btn {
                padding: 10px 20px; /* Consistent padding */
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 1rem;
                text-decoration: none; /* Remove underline from link */
                color: white; /* Default text color */
                transition: background-color 0.2s ease, opacity 0.2s ease;
                display: inline-block; /* Ensure label and link behave like buttons */
                text-align: center;
                white-space: nowrap; /* Prevent button text wrapping */
            }
            .action-btn:hover {
                opacity: 0.9; /* Slight hover effect */
            }

            /* Specific Button Styles (Keep your existing or use these) */
            .import-btn {
                background-color: #007bff; /* Blue for import */
                /* Inherits .action-btn styles */
            }
            .import-btn:hover {
                background-color: #0056b3;
            }

            .template-btn {
                background-color: #6c757d; /* Grey for template/info */
                /* Inherits .action-btn styles */
                color: white !important; /* Ensure link text is white */
            }
            .template-btn:hover {
                background-color: #5a6268;
            }

            .save-btn {
                background-color: #28a745; /* Green for save */
                /* Inherits .action-btn styles */
                /* Align this button with the top of the other group on large screens */
                align-self: flex-start;
            }
            .save-btn:hover {
                background-color: #218838;
            }

            /* Hide the actual file input */
            #excel-file-input {
                display: none;
            }

            /* Status Message Styling */
            #import-status {
                flex-basis: 100%; /* Make status take full width within its group */
                order: 3; /* Ensure status appears after the buttons in its group */
                margin-top: 10px; /* Space above the status message */
                font-size: 0.9em;
                min-height: 1.2em; /* Prevent layout shift */
                text-align: left; /* Align status text left by default */
                padding-left: 0; /* No extra indent needed here */
                color: #333; /* Default color */
            }
            #import-status.success {
                color: #28a745;
                font-weight: bold;
            }
            #import-status.error {
                color: #dc3545;
                font-weight: bold;
            }

            /* --- Summary Section --- */
            .summary {
                margin-top: 25px;
                padding: 20px;
                background-color: #e9f7ef;
                border: 1px solid #c3e6cb;
                border-radius: 5px;
                color: #155724;
            }
            .summary h3 {
                margin-top: 0;
                margin-bottom: 15px;
                color: #004085;
                border-bottom: 1px solid #b8daff;
                padding-bottom: 8px;
            }
            .summary p {
                margin: 8px 0;
                font-size: 1.05rem;
            }
            .summary span {
                font-weight: bold;
            }

            /* --- Weekend Highlight --- */
            .weekend {
                background-color: #fff3cd !important;
                color: #856404;
            }
            .weekend td:first-child,
            .weekend td:nth-child(2) {
                font-weight: bold;
            }

            /* --- RWD Media Queries --- */
            @media (max-width: 992px) {
                .container {
                    max-width: 90%;
                    padding: 20px;
                }
                h1 {
                    font-size: 1.8em;
                }
            }

            @media (max-width: 768px) {
                body {
                    padding: 15px;
                    font-size: 15px;
                }
                .container {
                    max-width: 100%;
                    padding: 15px;
                    margin: 15px auto;
                }
                h1 {
                    font-size: 1.6em;
                    margin-bottom: 20px;
                }
                .controls {
                    margin-bottom: 20px;
                }
                .month-selector {
                    flex-direction: column;
                    align-items: stretch;
                    padding: 15px;
                    gap: 12px;
                }
                .month-selector label {
                    margin-bottom: 3px;
                    text-align: left;
                    align-self: flex-start;
                }
                .month-selector select,
                .month-nav-btn {
                    width: 100%;
                    box-sizing: border-box;
                    text-align: center;
                }
                .month-selector label[for='month'] {
                    margin-left: 0;
                }
                .month-nav-btn {
                    padding: 9px 12px;
                }
                th,
                td {
                    padding: 8px 10px;
                    font-size: 0.95em;
                }
                .time-input {
                    width: 130px;
                    padding: 5px 6px;
                    font-size: 0.9em;
                }

                /* RWD for Action Buttons */
                .action-buttons {
                    justify-content: center; /* Center items when they wrap */
                    gap: 15px; /* Reduce gap */
                }
                /* Center the inner group's content too */
                .button-group-left {
                    justify-content: center;
                }
                .action-btn {
                    padding: 9px 18px;
                    font-size: 0.95rem;
                    /* Optional: Allow buttons to grow */
                    /* flex-grow: 1; */
                    /* min-width: 110px; */
                }
                #import-status {
                    text-align: center; /* Center status text */
                    margin-top: 15px;
                }

                .summary {
                    padding: 15px;
                    margin-top: 20px;
                }
                .summary p {
                    font-size: 1rem;
                }
            }

            @media (max-width: 576px) {
                body {
                    padding: 10px;
                    font-size: 14px;
                }
                .container {
                    padding: 10px;
                    margin: 10px auto;
                    border-radius: 5px;
                }
                h1 {
                    font-size: 1.4em;
                    margin-bottom: 15px;
                }
                .month-selector {
                    padding: 12px;
                    gap: 10px;
                }
                th,
                td {
                    padding: 6px 8px;
                    font-size: 0.9em;
                }
                .time-input {
                    width: 125px;
                    font-size: 0.95em;
                }

                /* RWD for Action Buttons */
                /* Stack the main container items */
                .action-buttons {
                    flex-direction: column;
                    align-items: stretch; /* Make items full width */
                }
                /* Make buttons inside the left group also full width */
                .button-group-left {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 10px; /* Space between stacked buttons in group */
                }
                .action-btn {
                    width: 100%;
                    padding: 12px;
                    font-size: 1rem;
                    box-sizing: border-box; /* Include padding in width */
                }
                /* Ensure status stays at bottom */
                #import-status {
                    order: 5; /* Make sure it's last */
                    text-align: center;
                }

                .summary {
                    padding: 12px;
                    margin-top: 15px;
                }
                .summary h3 {
                    font-size: 1.1em;
                    margin-bottom: 10px;
                }
                .summary p {
                    font-size: 0.95rem;
                    margin: 5px 0;
                }
            }
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: rgba(0, 0, 0, 0.9); /* 可調整透明度或顏色 */
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }

            .loader {
                width: 90px;
                height: 14px;
                box-shadow: 0 3px 0 #fff;
                position: relative;
                clip-path: inset(-40px 0 -5px);
            }
            .loader:before {
                content: '';
                position: absolute;
                inset: auto calc(50% - 17px) 0;
                height: 50px;
                --g: no-repeat linear-gradient(#ccc 0 0);
                background: var(--g), var(--g), var(--g), var(--g);
                background-size: 16px 14px;
                animation: l7-1 2s infinite linear, l7-2 2s infinite linear;
            }
            @keyframes l7-1 {
                0%,
                100% {
                    background-position: 0 -50px, 100% -50px;
                }
                17.5% {
                    background-position: 0 100%, 100% -50px, 0 -50px, 100% -50px;
                }
                35% {
                    background-position: 0 100%, 100% 100%, 0 -50px, 100% -50px;
                }
                52.5% {
                    background-position: 0 100%, 100% 100%, 0 calc(100% - 16px), 100% -50px;
                }
                70%,
                98% {
                    background-position: 0 100%, 100% 100%, 0 calc(100% - 16px), 100% calc(100% - 16px);
                }
            }
            @keyframes l7-2 {
                0%,
                70% {
                    transform: translate(0);
                }
                100% {
                    transform: translate(200%);
                }
            }

            .toast-container {
                min-width: 200px;
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .toast {
                width: 100%;
                color: white;
                padding: 12px 24px;
                border-radius: 9999px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                font-weight: bold;
                animation: slideUp 0.3s ease, fadeOut 0.4s ease 2.6s forwards;
                max-width: 90vw;
                text-align: center;
            }

            .toast-success {
                background-color: #28a745;
            }

            .toast-error {
                background-color: #dc3545;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeOut {
                to {
                    opacity: 0;
                    transform: translateY(20px);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>冠宇加班費計算器</h1>

            <div class="controls">
                <div class="month-selector">
                    <label for="year">姓名:</label>
                    <input type="text" id="username" />
                    <label for="month">本月薪資:</label>
                    <input type="text" id="salary" />
                </div>
                <div class="month-selector">
                    <label for="year">年份:</label>
                    <select id="year" onchange="loadMonthData()"></select>
                    <label for="month">月份:</label>
                    <select id="month" onchange="loadMonthData()"></select>
                    <button id="prev-month-btn" class="month-nav-btn" onclick="goToPrevMonth()">上月</button>
                    <button id="next-month-btn" class="month-nav-btn" onclick="goToNextMonth()">下月</button>
                </div>
            </div>

            <div class="table-container">
                <table id="overtime-table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>星期</th>
                            <th>上班時間</th>
                            <th>下班時間</th>
                            <th>正常工時</th>
                            <th>加班時數</th>
                            <th>加班費</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- 表格內容會動態生成 -->
                    </tbody>
                </table>
            </div>

            <!-- Modified Action Buttons Section -->
            <div class="action-buttons">
                <div class="button-group-left">
                    <!-- Added a class for easier targeting -->
                    <!-- Wrapper for import button and status -->
                    <label for="excel-file-input" class="action-btn import-btn">匯入 Excel</label>
                    <input type="file" id="excel-file-input" accept=".xlsx, .xls" onchange="handleExcelImport(event)" />
                    <!-- Changed the invalid button to a styled link -->
                    <a href="https://louis-check-in-html.vercel.app/excelDemo.xlsx" target="_blank" class="action-btn template-btn">Excel 範本下載</a>
                    <div id="import-status"></div>
                    <!-- Status message area -->
                </div>

                <button class="action-btn save-btn" onclick="saveData()">存 檔</button>
                <!-- Keep save button separate -->
            </div>
            <!-- End Modified Section -->

            <div class="summary">
                <h3>本月加班統計</h3>
                <p>總加班時數: <span id="total-hours">0</span> 小時</p>
                <p>總加班費: <span id="total-pay">0</span> 元</p>
            </div>
        </div>
        <div class="loading-overlay">
            <div class="loader"></div>
        </div>
        <div class="toast-container" id="toast-container"></div>

        <script>
            // 全局變量
            let monthData = [];
            const hourlyRate = 200; // 假設每小時加班費為200元
            const normalHours = 9; // 正常工作時數
            const weekdayNames = ['日', '一', '二', '三', '四', '五', '六'];

            // 頁面加載時初始化
            window.onload = function () {
                populateYearOptions();
                populateMonthOptions();
                loadMonthData(); // Initial load
            };

            // --- (populateYearOptions, populateMonthOptions, getDaysInMonth functions remain the same) ---
            function populateYearOptions() {
                const yearSelect = document.getElementById('year');
                const currentYear = new Date().getFullYear();
                const startYear = currentYear - 1;
                const endYear = currentYear + 3; // Add a few future years, like 2025

                for (let i = startYear; i <= endYear; i++) {
                    // Adjusted loop
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i + '年';
                    if (i === currentYear) {
                        option.selected = true; // Default to current year
                    }
                    yearSelect.appendChild(option);
                }
                // Add 2025 if it wasn't in the initial range, but don't select it by default
                if (!yearSelect.querySelector('option[value="2025"]')) {
                    const option2025 = document.createElement('option');
                    option2025.value = 2025;
                    option2025.textContent = '2025年';
                    yearSelect.appendChild(option2025);
                }
            }

            function populateMonthOptions() {
                const monthSelect = document.getElementById('month');
                const currentMonth = new Date().getMonth() + 1;

                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i + '月';
                    if (i === currentMonth) {
                        // Default to current month
                        option.selected = true;
                    }
                    monthSelect.appendChild(option);
                }
            }
            function getDaysInMonth(year, month) {
                return new Date(year, month, 0).getDate();
            }

            function loadMonthData() {
                document.querySelector('.loading-overlay').style.display = 'flex';
                const year = parseInt(document.getElementById('year').value);
                const month = parseInt(document.getElementById('month').value);

                // 先從後端獲取數據
                fetch(`/api/overtime?year=${year}&month=${month}`)
                    .then((response) => response.json())
                    .then((data) => {
                        // 將數據轉換為以日期為鍵的對象，方便後續處理
                        const dataMap = {};
                        data.forEach((item) => {
                            dataMap[item.date] = item;
                        });

                        // 創建整月的數據
                        const daysInMonth = getDaysInMonth(year, month);
                        monthData = [];

                        for (let day = 1; day <= daysInMonth; day++) {
                            const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const dayDate = new Date(year, month - 1, day);
                            const weekday = dayDate.getDay(); // 0 是星期日，1-6 是星期一到星期六

                            // 如果有現有數據，使用它，否則創建新項目
                            if (dataMap[date]) {
                                monthData.push({
                                    ...dataMap[date],
                                    weekday: weekdayNames[weekday],
                                });
                            } else {
                                monthData.push({
                                    date: date,
                                    weekday: weekdayNames[weekday],
                                    startTime: '',
                                    endTime: '',
                                    overtimeHours: 0,
                                    overtimePay: 0,
                                });
                            }
                        }

                        renderTable();
                        updateSummary();
                    })
                    .catch((error) => {
                        console.error('獲取資料失敗:', error);

                        // 如果加載失敗，使用空數據創建整月表格
                        const year = parseInt(document.getElementById('year').value);
                        const month = parseInt(document.getElementById('month').value);
                        const daysInMonth = getDaysInMonth(year, month);
                        monthData = [];

                        for (let day = 1; day <= daysInMonth; day++) {
                            const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const dayDate = new Date(year, month - 1, day);
                            const weekday = dayDate.getDay();

                            monthData.push({
                                date: date,
                                weekday: weekdayNames[weekday],
                                startTime: '',
                                endTime: '',
                                overtimeHours: 0,
                                overtimePay: 0,
                            });
                        }

                        renderTable();
                        updateSummary();
                        showToast('初始化失敗！', 'error')
                    })
                    .finally(function () {
                        document.querySelector('.loading-overlay').style.display = 'none';
                    });
            }

            function createEmptyMonthData(year, month) {
                const daysInMonth = getDaysInMonth(year, month);
                monthData = [];
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayDate = new Date(year, month - 1, day);
                    const weekday = dayDate.getDay();
                    monthData.push({
                        date: date,
                        weekday: weekdayNames[weekday],
                        startTime: '',
                        endTime: '',
                        overtimeHours: 0,
                        overtimePay: 0,
                    });
                }
            }

            function goToPrevMonth() {
                const yearSelect = document.getElementById('year');
                const monthSelect = document.getElementById('month');
                let currentYear = parseInt(yearSelect.value);
                let currentMonth = parseInt(monthSelect.value);
                currentMonth--;
                if (currentMonth < 1) {
                    currentMonth = 12;
                    currentYear--;
                }
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                    yearSelect.value = currentYear;
                    monthSelect.value = currentMonth;
                    loadMonthData();
                } else {
                    alert(`無法切換到 ${currentYear} 年，該年份不在選項中。`);
                }
            }

            function goToNextMonth() {
                const yearSelect = document.getElementById('year');
                const monthSelect = document.getElementById('month');
                let currentYear = parseInt(yearSelect.value);
                let currentMonth = parseInt(monthSelect.value);
                currentMonth++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                    yearSelect.value = currentYear;
                    monthSelect.value = currentMonth;
                    loadMonthData();
                } else {
                    alert(`無法切換到 ${currentYear} 年，該年份不在選項中。`);
                }
            }

            // --- (renderTable function remains the same) ---
            function renderTable() {
                const tableBody = document.getElementById('table-body');
                if (!tableBody) {
                    console.error('Table body not found!');
                    return;
                }
                tableBody.innerHTML = ''; // Clear existing rows

                monthData.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    const isWeekend = entry.weekday === '六' || entry.weekday === '日';
                    if (isWeekend) {
                        row.classList.add('weekend');
                    }

                    // Date
                    const dateCell = document.createElement('td');
                    dateCell.textContent = entry.date.slice(5); // MM-DD
                    row.appendChild(dateCell);

                    // Weekday
                    const weekdayCell = document.createElement('td');
                    weekdayCell.textContent = entry.weekday;
                    row.appendChild(weekdayCell);

                    // Start Time
                    const startTimeCell = document.createElement('td');
                    const startTimeInput = document.createElement('input');
                    startTimeInput.type = 'time';
                    startTimeInput.className = 'time-input';
                    startTimeInput.value = entry.startTime || '';
                    // Use a data attribute to store the index easily
                    startTimeInput.setAttribute('data-index', index);
                    startTimeInput.onchange = (event) => updateTimeFromInput(event, 'startTime');
                    startTimeCell.appendChild(startTimeInput);
                    row.appendChild(startTimeCell);

                    // End Time
                    const endTimeCell = document.createElement('td');
                    const endTimeInput = document.createElement('input');
                    endTimeInput.type = 'time';
                    endTimeInput.className = 'time-input';
                    endTimeInput.value = entry.endTime || '';
                    endTimeInput.setAttribute('data-index', index);
                    endTimeInput.onchange = (event) => updateTimeFromInput(event, 'endTime');
                    endTimeCell.appendChild(endTimeInput);
                    row.appendChild(endTimeCell);

                    // Normal Hours
                    const normalHoursCell = document.createElement('td');
                    normalHoursCell.textContent = normalHours;
                    row.appendChild(normalHoursCell);

                    // Overtime Hours (Read-only)
                    const overtimeHoursCell = document.createElement('td');
                    overtimeHoursCell.textContent = entry.overtimeHours ? entry.overtimeHours.toFixed(2) : '0';
                    row.appendChild(overtimeHoursCell);

                    // Overtime Pay (Read-only)
                    const overtimePayCell = document.createElement('td');
                    overtimePayCell.textContent = entry.overtimePay ? entry.overtimePay.toFixed(0) : '0'; // Use toFixed(2) for currency
                    row.appendChild(overtimePayCell);

                    tableBody.appendChild(row);
                });
            }

            // Helper function to handle input changes
            function updateTimeFromInput(event, field) {
                const inputElement = event.target;
                const index = parseInt(inputElement.getAttribute('data-index'), 10);
                const value = inputElement.value;
                updateTimeAndCalculate(index, field, value);
            }

            // Refactored calculation logic into its own function
            function calculateSingleRow(index) {
                const entry = monthData[index];
                if (!entry) return; // Safety check

                if (entry.startTime && entry.endTime) {
                    // Use a fixed date (like 2000-01-01) to compare times correctly
                    const baseDate = '2000-01-01T';
                    const startDateTime = new Date(baseDate + entry.startTime);
                    const endDateTime = new Date(baseDate + entry.endTime);

                    // Handle overnight shifts: if end time is earlier than start time, add a day to end time
                    if (endDateTime < startDateTime) {
                        endDateTime.setDate(endDateTime.getDate() + 1);
                    }

                    // Calculate duration in milliseconds and convert to hours
                    const durationMs = endDateTime - startDateTime;
                    const totalWorkHours = durationMs / (1000 * 60 * 60);

                    // Calculate overtime hours (ensure non-negative)
                    const calculatedOvertimeHours = Math.max(0, totalWorkHours - normalHours);

                    entry.overtimeHours = calculatedOvertimeHours;
                    entry.overtimePay = calculatedOvertimeHours * hourlyRate;
                } else {
                    // If start or end time is missing, reset overtime
                    entry.overtimeHours = 0;
                    entry.overtimePay = 0;
                }
            }

            // Update time, calculate for that row, then re-render and update summary
            function updateTimeAndCalculate(index, field, value) {
                if (index >= 0 && index < monthData.length) {
                    monthData[index][field] = value;
                    calculateSingleRow(index); // Calculate only the affected row
                    // OPTIMIZATION: Instead of full re-render, update only the affected row's display
                    updateTableRowDisplay(index);
                    updateSummary(); // Recalculate and display summary
                } else {
                    console.error(`Invalid index ${index} for updateTimeAndCalculate`);
                }
            }

            // OPTIMIZATION: Update specific cells instead of full table re-render
            function updateTableRowDisplay(index) {
                const row = document.querySelector(`#table-body tr:nth-child(${index + 1})`); // Get the specific row
                if (row && monthData[index]) {
                    const entry = monthData[index];
                    // Update overtime hours cell
                    const hoursCell = row.cells[5]; // 6th cell (index 5)
                    if (hoursCell) hoursCell.textContent = entry.overtimeHours.toFixed(2);
                    // Update overtime pay cell
                    const payCell = row.cells[6]; // 7th cell (index 6)
                    if (payCell) payCell.textContent = entry.overtimePay.toFixed(2);
                }
            }

            // --- (updateSummary function remains the same) ---
            function updateSummary() {
                let totalHours = 0;
                let totalPay = 0;
                monthData.forEach((entry) => {
                    totalHours += entry.overtimeHours || 0;
                    totalPay += entry.overtimePay || 0;
                });
                document.getElementById('total-hours').textContent = totalHours.toFixed(2);
                document.getElementById('total-pay').textContent = totalPay.toFixed(2); // Use toFixed(2) for currency
            }

            // --- (saveData function remains the same) ---
            function saveData() {
                document.querySelector('.loading-overlay').style.display = 'flex';

                const year = parseInt(document.getElementById('year').value);
                const month = parseInt(document.getElementById('month').value);
                const dataToSave = monthData.filter((entry) => entry.startTime || entry.endTime);

                console.log('Saving data:', { year, month, data: dataToSave }); // For testing

                fetch('/api/overtime', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year: year, month: month, data: dataToSave }),
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then((result) => {
                        console.log('Save success:', result);
                        showToast('存檔成功！', 'success')
                    })
                    .catch((error) => {
                        showToast('存檔失敗！', 'error')
                        console.error('存檔失敗:', error);
                    })
                    .finally(function () {
                        document.querySelector('.loading-overlay').style.display = 'none';
                    });
            }

            // --- NEW: Excel Import Functionality ---
            function handleExcelImport(event) {
                const file = event.target.files[0];
                const statusDiv = document.getElementById('import-status');
                const fileInput = document.getElementById('excel-file-input');

                statusDiv.textContent = ''; // Clear previous status
                statusDiv.className = ''; // Clear status class

                if (!file) {
                    return;
                }

                // Basic check for Excel file types
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                    statusDiv.textContent = '請選擇 .xlsx 或 .xls 格式的檔案。';
                    statusDiv.className = 'error';
                    fileInput.value = ''; // Reset file input
                    return;
                }

                statusDiv.textContent = '正在讀取檔案...';
                statusDiv.className = ''; // Reset class

                const reader = new FileReader();

                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    processExcelData(data);
                };

                reader.onerror = function (e) {
                    console.error('File reading error:', e);
                    statusDiv.textContent = '讀取檔案時發生錯誤。';
                    statusDiv.className = 'error';
                    fileInput.value = ''; // Reset file input
                };

                reader.readAsArrayBuffer(file);
            }

            function processExcelData(data) {
                const statusDiv = document.getElementById('import-status');
                const fileInput = document.getElementById('excel-file-input');
                statusDiv.textContent = '正在解析 Excel 內容...';
                statusDiv.className = ''; // Reset class

                try {
                    // Use { cellDates: true } to help SheetJS parse dates and times as JS Date objects
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Use { header: 1 } to get arrays for each row (easier index access)
                    // Use { raw: false } to get formatted strings where possible
                    // Use dateNF to suggest a format if raw dates are encountered (helps sometimes)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, dateNF: 'yyyy-mm-dd hh:mm:ss' });

                    // --- Data Mapping and Updating ---
                    const currentYear = parseInt(document.getElementById('year').value);
                    const currentMonth = parseInt(document.getElementById('month').value);
                    let importCount = 0;
                    let rowsProcessed = 0;

                    // Start from row 1 (index 1) to skip the header row (index 0)
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        rowsProcessed++;

                        // Skip empty rows or rows without enough data
                        if (!row || row.length < 3 || (!row[0] && !row[1] && !row[2])) {
                            // console.log(`Skipping empty or short row ${i + 1}`);
                            continue;
                        }

                        let dateValue = row[0]; // Column A: Date
                        let startTimeValue = row[1]; // Column B: Start Time
                        let endTimeValue = row[2]; // Column C: End Time

                        // --- Date Parsing ---
                        let dayOfMonth;
                        let targetDateStr = null;

                        if (dateValue instanceof Date) {
                            // Best case: SheetJS parsed it correctly
                            // Check if the date belongs to the currently selected month/year
                            if (dateValue.getFullYear() === currentYear && dateValue.getMonth() + 1 === currentMonth) {
                                dayOfMonth = dateValue.getDate();
                                targetDateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(dayOfMonth).padStart(2, '0')}`;
                            } else {
                                console.warn(`Skipping Excel row ${i + 1}: Date ${dateValue.toLocaleDateString()} is not in ${currentYear}-${currentMonth}.`);
                                continue; // Skip if date doesn't match
                            }
                        } else if (typeof dateValue === 'number' && dateValue >= 1 && dateValue <= 31) {
                            // Just the day number
                            dayOfMonth = dateValue;
                            targetDateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(dayOfMonth).padStart(2, '0')}`;
                        } else if (typeof dateValue === 'string') {
                            // Try parsing string date
                            try {
                                // Attempt to parse common formats (might need more robust library for complex cases)
                                const parsedDate = new Date(dateValue);
                                if (!isNaN(parsedDate) && parsedDate.getFullYear() === currentYear && parsedDate.getMonth() + 1 === currentMonth) {
                                    dayOfMonth = parsedDate.getDate();
                                    targetDateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(dayOfMonth).padStart(2, '0')}`;
                                } else {
                                    console.warn(`Skipping Excel row ${i + 1}: String Date "${dateValue}" is not in ${currentYear}-${currentMonth} or invalid.`);
                                    continue;
                                }
                            } catch (e) {
                                console.warn(`Skipping Excel row ${i + 1}: Could not parse date string "${dateValue}".`);
                                continue;
                            }
                        } else {
                            console.warn(`Skipping Excel row ${i + 1}: Unrecognized date format in Column A:`, dateValue);
                            continue; // Skip if date format is unusable
                        }

                        // --- Time Formatting (Handles JS Date objects, Excel time numbers, or "HH:MM" strings) ---
                        function formatTimeFromExcel(timeValue) {
                            if (!timeValue) return ''; // Handle empty cell
                            if (timeValue instanceof Date) {
                                // Extract HH:MM from Date object
                                return `${String(timeValue.getHours()).padStart(2, '0')}:${String(timeValue.getMinutes()).padStart(2, '0')}`;
                            } else if (typeof timeValue === 'number' && timeValue > 0 && timeValue < 1) {
                                // Handle Excel time serial number (fraction of a day)
                                // Convert fraction of day to HH:MM
                                const totalMinutes = Math.round(timeValue * 1440); // 24 * 60
                                const hours = Math.floor(totalMinutes / 60);
                                const minutes = totalMinutes % 60;
                                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                            } else if (typeof timeValue === 'string') {
                                // Try to match HH:MM or H:MM (with optional AM/PM - ignored)
                                const match = timeValue.match(/(\d{1,2}):(\d{2})/);
                                if (match) {
                                    return `${String(match[1]).padStart(2, '0')}:${String(match[2]).padStart(2, '0')}`;
                                }
                            }
                            console.warn(`Could not format time from value:`, timeValue);
                            return ''; // Return empty if format is unknown/unparsable
                        }

                        const startTimeStr = formatTimeFromExcel(startTimeValue);
                        const endTimeStr = formatTimeFromExcel(endTimeValue);

                        if (!startTimeStr && !endTimeStr) {
                            // console.log(`Skipping row for date ${targetDateStr}: No valid start or end time found.`);
                            continue; // Skip if both times are invalid/empty
                        }

                        // --- Find matching entry in monthData and update ---
                        const entryIndex = monthData.findIndex((entry) => entry.date === targetDateStr);

                        if (entryIndex !== -1) {
                            let updated = false;
                            if (startTimeStr && monthData[entryIndex].startTime !== startTimeStr) {
                                monthData[entryIndex].startTime = startTimeStr;
                                updated = true;
                            }
                            if (endTimeStr && monthData[entryIndex].endTime !== endTimeStr) {
                                monthData[entryIndex].endTime = endTimeStr;
                                updated = true;
                            }

                            if (updated) {
                                calculateSingleRow(entryIndex); // Recalculate after setting times
                                importCount++;
                            }
                        } else {
                            console.warn(`Skipping Excel row ${i + 1}: Date ${targetDateStr} not found in the current table view.`);
                        }
                    } // End loop through Excel rows

                    // --- Final Updates ---
                    if (importCount > 0) {
                        renderTable(); // Re-render the entire table with updated data
                        updateSummary(); // Update totals
                        statusDiv.textContent = `成功匯入 ${importCount} 筆記錄。 (共處理 ${rowsProcessed} 行)`;
                        statusDiv.className = 'success';
                    } else if (rowsProcessed > 0) {
                        statusDiv.textContent = `處理了 ${rowsProcessed} 行，但沒有找到可更新的日期或時間。請檢查 Excel 檔案內容和目前選擇的月份 (${currentYear}/${currentMonth})。`;
                        statusDiv.className = 'error';
                    } else {
                        statusDiv.textContent = 'Excel 檔案為空或未包含有效資料。';
                        statusDiv.className = 'error';
                    }
                } catch (error) {
                    console.error('Excel processing error:', error);
                    statusDiv.textContent = '解析 Excel 檔案時發生錯誤，請確認檔案格式正確。';
                    statusDiv.className = 'error';
                } finally {
                    // Reset the file input so the user can select the same file again if needed
                    fileInput.value = '';
                    // Optional: Clear status after a few seconds
                    // setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = ''; }, 7000);
                }
            }
            function showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        </script>
    </body>
</html>
